# Tor сеть

## Введение

**Tor (The Onion Router)** — это распределённая сеть, разработанная Лабораторией информационной безопасности военно-морского флота США, которая обеспечивает анонимную и конфиденциальную коммуникацию в интернете. Сеть Tor позволяет пользователям скрывать свой географический адрес и источник трафика, маршрутизируя данные через множество добровольно управляемых узлов, разбросанных по всему миру. Проект остаётся активным, а его последняя версия (0.4.8.20 по состоянию на 11.11.2025) постоянно совершенствуется.

## Уровень сложности

Средний — для понимания требуется базовое знание о сетевых протоколах, шифровании и принципах работы прокси-серверов.

## Архитектура и принцип работы

### Луковая маршрутизация (Onion Routing)

Основной принцип работы Tor основан на технологии **луковой маршрутизации**, которая скрывает источник и пункт назначения трафика. Данные пользователя многократно шифруются и отправляются через цепь случайно выбранных узлов, известных как релеи. Каждый узел расшифровывает только один уровень шифрования, получая информацию только о предыдущем и следующем узле в цепи. Ни один отдельный узел не знает полный маршрут пакета.

Процесс работает по следующему принципу:

1. **Выбор маршрута** — клиент выбирает цепь из трёх релеев: входной (entry guard), промежуточный (middle relay) и выходной (exit relay).
2. **Послойное шифрование** — данные шифруются в обратном порядке: сначала для выходного узла, затем для промежуточного, наконец для входного.
3. **Прохождение через цепь** — пакет проходит через три узла, каждый из которых удаляет один слой шифрования.
4. **Выход в интернет** — выходной узел подключается к целевому веб-сайту.

Ответные данные проходят обратный путь, проходя через туннель в обратном порядке.

### Компоненты сети Tor

**Релеи (узлы)** — добровольные компьютеры, которые передают трафик через сеть Tor. Каждый релей вносит вклад в скрытие маршрута и помогает масштабировать пропускную способность сети. Существует несколько типов релеев:

- **Entry guards** — первые узлы в цепи, через которые проходит трафик пользователя. Они выбираются Tor Browser и сохраняются для снижения риска атак, связанных с выбором входных узлов.
- **Middle relays** — промежуточные узлы, которые передают трафик дальше. Они не видят ни источник, ни пункт назначения.
- **Exit relays** — последние узлы, через которые трафик выходит в публичный интернет. Они видят содержимое несифрованного трафика (хотя для HTTPS трафика содержимое остаётся защищено шифрованием конца в конца).

**Directory authorities** — специальные узлы, которые хранят информацию об активных релеях и выпускают консенсусный список, позволяя всем клиентам знать о доступных узлах. Существует около десяти directory authorities, управляемых различными организациями.

**Tor Browser** — специально настроенный браузер на базе Firefox, который подключается к сети Tor через локальный демон (Tor daemon) и автоматически маршрутизирует весь интернет-трафик через сеть.

### Шифрование и криптография

Tor использует несколько уровней шифрования для защиты данных:

- **Многоуровневое шифрование** — каждый слой соответствует релею в цепи. Данные шифруются с использованием криптографических ключей каждого релея.
- **TLS для связи между релеями** — связь между узлами Tor защищена TLS для предотвращения пассивного подслушивания.
- **End-to-end encryption для HTTPS** — если пользователь подключается к HTTPS-сайту, шифрование применяется дважды: один раз на уровне Tor, второй раз на уровне HTTPS.

## Примеры использования

### 1. Анонимный просмотр веб-сайтов через Tor Browser

Это наиболее распространённый способ использования Tor. Пользователь загружает и устанавливает Tor Browser, и все его веб-запросы автоматически маршрутизируются через сеть Tor. Браузер также отключает скрипты, плагины и другие функции, которые могут деанонимизировать пользователя.

**Пример**: журналист в стране с цензурой может использовать Tor Browser для безопасного чтения новостей международных СМИ, не раскрывая свой IP-адрес и местоположение.

### 2. Настройка SOCKS5 прокси через Tor

Tor предоставляет локальный SOCKS5 прокси на порте 9050 (или 9051 в некоторых конфигурациях). Приложения, которые поддерживают SOCKS5 прокси, могут быть настроены для маршрутизации трафика через Tor.

**Пример конфигурации в приложении:**
- Адрес прокси: `127.0.0.1` или `localhost`
- Порт: `9050`
- Тип прокси: SOCKS5

Это позволяет использовать Tor не только в браузере, но и в других приложениях, таких как мессенджеры, клиенты электронной почты или утилиты командной строки (curl, wget).

### 3. Автоматическая смена IP-адреса

Tor автоматически создаёт новую цепь релеев при каждом новом подключении, что приводит к смене видимого IP-адреса. Пользователь может явно запросить новый IP-адрес в Tor Browser или использовать инструменты командной строки для управления цепью.

**Пример использования**: исследователь использует Tor для сбора данных с веб-сайтов, меняя IP-адрес при каждом запросе, чтобы избежать блокировки.

### 4. Обход блокировок и цензуры

В странах, где доступ к определённым веб-сайтам ограничен или блокирован, Tor позволяет пользователям получать доступ к контенту. Сеть поддерживает **мосты (bridges)** — специальные входные узлы, которые не указаны в публичном списке релеев. Это затрудняет провайдерам интернета блокировку Tor.

**Пример**: студент в стране с жёсткой цензурой может использовать Tor с мостами для доступа к образовательным ресурсам.

### 5. Размещение .onion сервисов (скрытых сервисов)

Tor позволяет размещать веб-сайты и услуги, которые доступны только через сеть Tor. Эти сайты получают адреса с расширением `.onion`. V3 onion адреса используют 56 символов и основаны на криптографии эллиптических кривых, что делает их более безопасными, чем более старые V2 адреса.

**Пример**: организация по правам человека может размещать новостной сайт на `.onion` адресе для защиты от цензуры и отслеживания.

## Безопасность и ограничения

### Преимущества

- **Сильная анонимность** — благодаря многоуровневому шифрованию и использованию множества независимых узлов, сложно отследить пользователя.
- **Защита от наблюдения ISP** — провайдер интернета видит только, что пользователь подключен к Tor, но не может видеть содержимое трафика или целевые сайты.
- **Откритый исходный код** — Tor находится в открытом доступе, что позволяет сообществу проверять безопасность.
- **Бесплатный доступ** — сеть Tor полностью бесплатна, как и клиентское программное обеспечение.

### Риски и ограничения

- **Медленность** — трафик проходит через несколько узлов и подвергается многоуровневому шифрованию, что снижает скорость подключения. Это может привести к заметной задержке при загрузке веб-страниц.
- **Уязвимость exit-узлов** — выходной узел может видеть несифрованный трафик (например, HTTP-запросы) и потенциально перехватывать данные. Использование HTTPS критически важно для защиты при передаче чувствительных данных.
- **Timing-атаки** — противник, контролирующий входной и выходной узлы, может использовать анализ времени передачи пакетов для корреляции входящего и исходящего трафика и определения источника.
- **Browser fingerprinting** — даже при использовании Tor Browser, веб-сайты могут собирать данные о вашей системе (операционная система, версия браузера, разрешение экрана и т. д.) для идентификации пользователя.
- **User mistakes** — неправильное использование (например, загрузка документов, содержащих личную информацию, или максимизация окна браузера в полный экран) может раскрыть личность пользователя.
- **Выходные узлы, управляемые противниками** — хотя и редко, некоторые выходные узлы могут быть установлены злоумышленниками для сбора данных пользователей.

### Защита от отслеживания

Tor Browser включает несколько встроенных мер для защиты от отслеживания и дескрипции:

- **Отключение JavaScript** — по умолчанию JavaScript отключен в некоторых зонах безопасности браузера, чтобы предотвратить утечки IP-адреса.
- **Изоляция цепей** — каждый сайт получает свой набор релеев, что затрудняет связывание активности пользователя на разных сайтах.
- **Защита от canvas fingerprinting** — браузер возвращает ложные данные для методов отслеживания на основе canvas.
- **Минимизация видимых различий между браузерами** — все экземпляры Tor Browser имеют одинаковые характеристики, что затрудняет различение пользователей.

## Расширенная конфигурация

### Использование мостов (Bridges)

Мосты — это релеи, которые не перечислены в публичном каталоге Tor. Они помогают обходить блокировки на уровне ISP, которые препятствуют прямому подключению к сети Tor.

**Получение мостов:**
1. Посетите https://bridges.torproject.org
2. Решите CAPTCHA
3. Выберите тип моста (obfs4 рекомендуется)
4. Скопируйте адреса мостов

**Подключение через мосты в Tor Browser:**
1. Откройте меню настроек Tor Browser
2. Перейдите в раздел "Tor Settings"
3. Включите опцию "Use a Bridge"
4. Вставьте адреса мостов

### Pluggable Transports

Pluggable Transports — это подключаемые модули, которые скрывают трафик Tor, маскируя его под обычный интернет-трафик (например, под видеопотоки или другие популярные протоколы).

**Наиболее распространённые:**
- **obfs4** — маскирует трафик Tor под случайный поток данных, что затрудняет его обнаружение Deep Packet Inspection (DPI) инструментами.
- **meek** — использует облачные сервисы (Google, Azure, CloudFront) в качестве frontingа, что затрудняет блокировку.

## Ресурсы для изучения

- **Официальный сайт Tor Project** — https://www.torproject.org/ — основной источник информации о Tor, включая загрузки и документацию.
- **Руководство пользователя Tor Browser** — https://support.torproject.org/ — подробное руководство по установке, конфигурации и использованию Tor Browser.
- **Спецификации Tor** — https://spec.torproject.org/ — технические спецификации протокола Tor для разработчиков и исследователей.
- **Форум сообщества Tor** — https://forum.torproject.org/ — активное сообщество, где можно задать вопросы и получить помощь.
- **Tor в России** — обсуждение особенностей использования Tor в условиях блокировок в России и других странах; форумы и каналы посвящены методам обхода цензуры.

## Важные примечания

### Этика и закон

Использование Tor легально в большинстве стран. Однако, Tor часто используется как для законных целей (журналистика, защита прав человека, конфиденциальность), так и для незаконных (продажа наркотиков, кража данных). Само по себе использование Tor не является преступлением, но использование его для незаконных целей приводит к уголовной ответственности.

### Отличие Tor от VPN

Хотя оба способа обеспечивают анонимность, между ними есть существенные различия:

- **VPN** — единая точка защиты; провайдер VPN видит весь ваш трафик. Скорость обычно выше.
- **Tor** — многоуровневая защита; ни один узел не видит полную картину. Скорость ниже из-за маршрутизации через несколько узлов.

### Рекомендации по безопасному использованию

1. **Всегда используйте HTTPS** — даже при использовании Tor, для защиты от промежуточных узлов.
2. **Не максимизируйте окно браузера** — используйте стандартное разрешение, чтобы затруднить идентификацию по разрешению экрана.
3. **Отключайте плагины** — Flash, Java и другие плагины могут обойти Tor и раскрыть ваш IP-адрес.
4. **Остерегайтесь социальной инженерии** — не переходите по подозрительным ссылкам и не скачивайте неизвестные файлы.
5. **Обновляйте Tor Browser** — регулярно обновляйте браузер для получения последних исправлений безопасности.
6. **Используйте мосты при необходимости** — если Tor заблокирован в вашей стране, используйте мосты для подключения.

### Текущее состояние сети Tor (2025)

На 11.11.2025 сеть Tor продолжает активно развиваться. Текущая версия торриуса (tor daemon) 0.4.8.20 включает постоянные улучшения в области безопасности, производительности и устойчивости к цензуре. Сеть насчитывает тысячи активных релеев, управляемых добровольцами со всего мира, и ежедневно защищает конфиденциальность миллионов пользователей.

## Примеры кода

### Использование curl через Tor SOCKS5 прокси

```bash
curl --socks5-hostname 127.0.0.1:9050 https://example.com
```

Эта команда отправляет запрос к example.com через Tor сеть, используя локальный SOCKS5 прокси на порте 9050.

### Python скрипт для подключения через Tor

```python
import requests
import socks
import socket

# Настройка SOCKS5 прокси
socks.set_default_proxy(socks.SOCKS5, "127.0.0.1", 9050)
socket.socket = socks.socksocket

# Создание сессии requests через Tor
session = requests.Session()
session.proxies = {
    'http': 'socks5://127.0.0.1:9050',
    'https': 'socks5://127.0.0.1:9050'
}

# Запрос к сайту
response = session.get('https://example.com')
print(response.text)
```

Для работы этого кода требуется установка пакета `PySocks`:
```bash
pip install PySocks requests
```

### Скрипт для изменения IP-адреса через Tor

```bash
#!/bin/bash

# Функция для изменения IP-адреса (требует tor controller на порте 9051)
change_tor_ip() {
    echo -e "AUTHENTICATE\nsignal NEWNYM\nQUIT" | nc localhost 9051
    sleep 1
}

# Вывод текущего IP-адреса
echo "Текущий IP-адрес:"
curl -s https://api.ipify.org

# Изменение IP
echo "Изменение IP-адреса..."
change_tor_ip

# Вывод нового IP-адреса
echo "Новый IP-адрес:"
curl -s https://api.ipify.org
```

Для работы этого скрипта требуется настроить контрольный порт Tor. В файле `torrc` добавьте:
```
ControlPort 9051
CookieAuthentication 1
```

## Заключение

Tor является мощным инструментом для защиты приватности и обхода цензуры в интернете. Благодаря своей архитектуре распределённой маршрутизации и многоуровневому шифрованию, он обеспечивает высокий уровень анонимности. Однако, как и любой инструмент, Tor имеет свои ограничения и требует ответственного использования. Для максимальной защиты важно понимать не только, как работает Tor, но и какие риски сопутствуют его использованию, а также следовать рекомендациям по безопасности.